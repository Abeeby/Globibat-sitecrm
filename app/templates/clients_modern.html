{% extends "base_modern.html" %}

{% block title %}Clients - Globibat CRM{% endblock %}
{% block page_title %}Gestion des Clients{% endblock %}
{% block page_description %}Gérez votre portefeuille clients et prospects{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <!-- Barre d'actions -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex gap-2">
                <div class="input-group" style="width: 300px;">
                    <span class="input-group-text">
                        <i class="ri-search-line"></i>
                    </span>
                    <input type="text" class="form-control" id="searchClients" placeholder="Rechercher un client...">
                </div>
                <select class="form-select" style="width: 150px;" id="filterType">
                    <option value="">Tous types</option>
                    <option value="Particulier">Particulier</option>
                    <option value="Entreprise">Entreprise</option>
                    <option value="Public">Public</option>
                </select>
                <select class="form-select" style="width: 120px;" id="filterStatus">
                    <option value="">Tous</option>
                    <option value="true">Actifs</option>
                    <option value="false">Inactifs</option>
                </select>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-secondary" onclick="exportClients()">
                    <i class="ri-download-line"></i> Exporter
                </button>
                <button class="btn btn-primary" onclick="openClientModal()">
                    <i class="ri-user-add-line"></i> Nouveau client
                </button>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar-sm bg-primary-soft text-primary rounded-circle">
                                    <i class="ri-group-line fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="mb-0">{{ total_clients|default(0) }}</h3>
                                <p class="text-muted mb-0">Total clients</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar-sm bg-success-soft text-success rounded-circle">
                                    <i class="ri-building-2-line fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="mb-0">{{ active_projects|default(0) }}</h3>
                                <p class="text-muted mb-0">Projets actifs</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar-sm bg-warning-soft text-warning rounded-circle">
                                    <i class="ri-file-text-line fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="mb-0">{{ pending_quotes|default(0) }}</h3>
                                <p class="text-muted mb-0">Devis en attente</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar-sm bg-info-soft text-info rounded-circle">
                                    <i class="ri-money-euro-circle-line fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="mb-0">{{ total_ca|default(0)|format_currency }}</h3>
                                <p class="text-muted mb-0">CA total</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des clients -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="clientsTable">
                        <thead>
                            <tr>
                                <th width="40">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </th>
                                <th>Code</th>
                                <th>Raison sociale</th>
                                <th>Type</th>
                                <th>Contact</th>
                                <th>Téléphone</th>
                                <th>Email</th>
                                <th>Ville</th>
                                <th>Projets</th>
                                <th>CA</th>
                                <th>Statut</th>
                                <th width="100">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in clients %}
                            <tr data-id="{{ client.id }}">
                                <td>
                                    <input class="form-check-input row-check" type="checkbox" value="{{ client.id }}">
                                </td>
                                <td><span class="badge badge-light">{{ client.code_client }}</span></td>
                                <td>
                                    <div>
                                        <h6 class="mb-0">{{ client.raison_sociale }}</h6>
                                        {% if client.siret %}
                                        <small class="text-muted">SIRET: {{ client.siret }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if client.type_client == 'Public' %}
                                        <span class="badge badge-primary">{{ client.type_client }}</span>
                                    {% elif client.type_client == 'Entreprise' %}
                                        <span class="badge badge-info">{{ client.type_client }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">{{ client.type_client }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ client.contact_principal|default('-') }}</td>
                                <td>{{ client.telephone|default('-') }}</td>
                                <td>{{ client.email|default('-') }}</td>
                                <td>{{ client.ville|default('-') }}</td>
                                <td>
                                    <span class="badge badge-light">{{ client.chantiers.count() }}</span>
                                </td>
                                <td>
                                    <strong>{{ client.chiffre_affaires|format_currency }}</strong>
                                </td>
                                <td>
                                    {% if client.actif %}
                                        <span class="badge badge-success">Actif</span>
                                    {% else %}
                                        <span class="badge badge-secondary">Inactif</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                            <i class="ri-more-2-fill"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="viewClient({{ client.id }})">
                                                    <i class="ri-eye-line me-2"></i> Voir détails
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="editClient({{ client.id }})">
                                                    <i class="ri-edit-line me-2"></i> Modifier
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="showProjects({{ client.id }})">
                                                    <i class="ri-building-2-line me-2"></i> Voir projets
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="createQuote({{ client.id }})">
                                                    <i class="ri-file-add-line me-2"></i> Nouveau devis
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#" onclick="deleteClient({{ client.id }})">
                                                    <i class="ri-delete-bin-line me-2"></i> Supprimer
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Client -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientModalTitle">Nouveau Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" name="id" id="clientId">
                    
                    <!-- Informations générales -->
                    <h6 class="mb-3">Informations générales</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Code client <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="code_client" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Type de client <span class="text-danger">*</span></label>
                                <select class="form-select" name="type_client" required>
                                    <option value="Particulier">Particulier</option>
                                    <option value="Entreprise">Entreprise</option>
                                    <option value="Public">Public</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Raison sociale <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="raison_sociale" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">SIRET</label>
                                <input type="text" class="form-control" name="siret">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">TVA Intracommunautaire</label>
                                <input type="text" class="form-control" name="tva_intracommunautaire">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact -->
                    <h6 class="mb-3 mt-4">Contact</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Contact principal</label>
                                <input type="text" class="form-control" name="contact_principal">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Téléphone</label>
                                <input type="tel" class="form-control" name="telephone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Adresse -->
                    <h6 class="mb-3 mt-4">Adresse</h6>
                    <div class="mb-3">
                        <label class="form-label">Adresse</label>
                        <textarea class="form-control" name="adresse" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Code postal</label>
                                <input type="text" class="form-control" name="code_postal">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Ville</label>
                                <input type="text" class="form-control" name="ville">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Pays</label>
                                <input type="text" class="form-control" name="pays" value="France">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paramètres -->
                    <h6 class="mb-3 mt-4">Paramètres</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Limite de crédit</label>
                                <input type="number" class="form-control" name="credit_limite" step="1000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Conditions de paiement</label>
                                <select class="form-select" name="conditions_paiement">
                                    <option value="30 jours">30 jours</option>
                                    <option value="45 jours">45 jours</option>
                                    <option value="60 jours">60 jours</option>
                                    <option value="Comptant">Comptant</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="actif" id="clientActif" checked>
                        <label class="form-check-label" for="clientActif">
                            Client actif
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveClient()">
                    <i class="ri-save-line"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-sm {
    width: 40px;
    height: 40px;
}

.bg-primary-soft { background-color: rgba(0, 91, 187, 0.1); }
.bg-success-soft { background-color: rgba(39, 174, 96, 0.1); }
.bg-warning-soft { background-color: rgba(255, 122, 0, 0.1); }
.bg-info-soft { background-color: rgba(0, 174, 239, 0.1); }
</style>

<script>
// Variables globales
let currentClientId = null;

// Recherche
document.getElementById('searchClients').addEventListener('input', function(e) {
    filterTable();
});

// Filtres
document.getElementById('filterType').addEventListener('change', filterTable);
document.getElementById('filterStatus').addEventListener('change', filterTable);

function filterTable() {
    const search = document.getElementById('searchClients').value.toLowerCase();
    const type = document.getElementById('filterType').value;
    const status = document.getElementById('filterStatus').value;
    const rows = document.querySelectorAll('#clientsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const typeMatch = !type || row.cells[3].textContent.includes(type);
        const statusMatch = !status || (status === 'true' ? row.cells[10].textContent.includes('Actif') : row.cells[10].textContent.includes('Inactif'));
        const searchMatch = !search || text.includes(search);
        
        row.style.display = (typeMatch && statusMatch && searchMatch) ? '' : 'none';
    });
}

// Sélection multiple
document.getElementById('selectAll').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.row-check');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Ouvrir modal nouveau client
function openClientModal() {
    currentClientId = null;
    document.getElementById('clientModalTitle').textContent = 'Nouveau Client';
    document.getElementById('clientForm').reset();
    document.getElementById('clientId').value = '';
    new bootstrap.Modal(document.getElementById('clientModal')).show();
}

// Voir détails client
function viewClient(id) {
    window.location.href = `/modern/clients/${id}`;
}

// Éditer client
function editClient(id) {
    currentClientId = id;
    document.getElementById('clientModalTitle').textContent = 'Modifier Client';
    
    // Charger les données du client
    fetch(`/api/clients/${id}`)
        .then(response => response.json())
        .then(data => {
            const form = document.getElementById('clientForm');
            document.getElementById('clientId').value = id;
            
            // Remplir le formulaire
            Object.keys(data).forEach(key => {
                if (form[key]) {
                    if (form[key].type === 'checkbox') {
                        form[key].checked = data[key];
                    } else {
                        form[key].value = data[key] || '';
                    }
                }
            });
            
            new bootstrap.Modal(document.getElementById('clientModal')).show();
        })
        .catch(error => {
            alert('Erreur lors du chargement des données');
            console.error(error);
        });
}

// Sauvegarder client
function saveClient() {
    const form = document.getElementById('clientForm');
    const formData = new FormData(form);
    const id = document.getElementById('clientId').value;
    
    // Convertir en JSON
    const data = {};
    formData.forEach((value, key) => {
        if (key === 'actif') {
            data[key] = form.actif.checked;
        } else {
            data[key] = value;
        }
    });
    
    const url = id ? `/api/clients/${id}` : '/api/clients';
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Erreur lors de l\'enregistrement');
        }
    })
    .catch(error => {
        alert('Erreur lors de l\'enregistrement');
        console.error(error);
    });
}

// Supprimer client
function deleteClient(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce client ?\nCette action est irréversible.')) {
        fetch(`/api/clients/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Erreur lors de la suppression');
            }
        })
        .catch(error => {
            alert('Erreur lors de la suppression');
            console.error(error);
        });
    }
}

// Voir projets du client
function showProjects(clientId) {
    window.location.href = `/modern/chantiers?client=${clientId}`;
}

// Créer un devis pour le client
function createQuote(clientId) {
    window.location.href = `/modern/devis/nouveau?client=${clientId}`;
}

// Exporter les clients
function exportClients() {
    window.location.href = '/api/clients/export';
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}